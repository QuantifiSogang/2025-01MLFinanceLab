### Mission Impossible : The Flawless Backtest

가장 협의적 관점에서 정의한다면 '백테스트란, 어떤 전략을 과거 시점 구간의 데이터에 적용했더라면 어떤 성과를 나타냈을까?' 하는 것을 역사적으로 시뮬레이션해 보는 것이다.
그렇기 때문에 백테스트는 실험이 아니라 그저 가상적인 것이다.
버클리 연구소와 같은 물리 실험실에서는 환경 변수를 통제한 후 실험을 반복해 정밀한 원인-결과 관계를 추론할 수 있다.
이에 반해 백테스트는 실험이 아니므로 아무것도 증명할 수 없다.
백테스트는 아무것도 보장하지 않으며, 개조한 드러리언 DMC-12를 타고 과거를 거슬러 올라가도 백테스트에서 얻은 Sharpe Ratio를 절대로 얻지 못한다.
랜덤 추출이라면 아마 달랐을지도 모른다. 과거는 자신을 반복하지 않는다.

그렇다면 백테스트가 왜 필요한가? 백테스트는 Betting size, Turnover, 비용에 대한 복원력, 주어진 시나리오에 대한 행동 등의 여러 변수에 관한 확인 검사다.
좋은 백테스트는 아주 유용하지만 백테스트를 잘한다는 것은 매우 힘들다. 
2014년 도이치 은행에서 Yin Luo가 이끄는 금융 분석 팀이 '정량 투자의 일곱 가지 죄악'이라는 제목의 연구서를 출간했다. 
업계에 있는 모든 사람이 신중하게 읽어 보길 권하는 보고서로서 그래픽이 풍부하고 쉽게 되어 있다.
거기에서 그 팀은 다음의 유력한 용의 대상들을 열거하고 있다.

1. Survivorship bias : Asset Universe를 지금 생존하는 것을 사용함으로써 파산되거나 상장 폐지된 증권 등에 대한 정보를 무시한다.
2. Look-ahead bias : 시뮬레이션이 실행된 당시에는 공개되지 않은 정보를 이용해 시뮬레이션 결정이 내려졌을 수 있다. 각 데이터 포인트의 타임스탬프를 확인하라. 배포 날짜와 배포 지연, 소급 수정 등을 고려해야 한다.
3. Storytelling : 특정 랜덤 패턴을 정당화하고자 사후에 스토리를 지어 낸다.
4. Data Mining and Data Snooping : 테스트 데이터를 활용해 모델을 학습한다.
5. Transaction cost : 거래 비용을 시뮬레이션하는 것은 매우 어렵다. 정확한 거래 비용을 산출하려면 거래 장부를 직접 보는 수밖에 없기 때문이다.
6. Outlier : 과거에 관측되었지만 다시는 나타날 것 같지 않은 소수 극단적 이상값에 바탕을 두고 전략을 수립한다.
7. Shorting : 현금성 증권에 공매도 포지션을 취하려면 증권 대출자를 찾아야 한다. 대출 비용과 가용 공매도 규모는 일반적으로 알려져 있지 않고, 인적 관계, 가용 재고, 상대적 수요 등에 따라 결정된다.

학술지에 기고한 많은 논문이 항상 저지르는 몇 가지 오류다. 또 다른 흔한 오류에는 비표준 방법을 사용해 성과를 측정하는 것이다. 
즉, 숨겨진 리스크를 무시하고 다른 척도는 무시한 채 수익률에만 집중하는 식이다.
또한 상관관계를 인과관계로 혼동하고, 대표성이 없는 기간을 선정하거나, 예기치 않은 상황을 고려하지 않거나, loss cut이나 margin call의 존재를 무시하거나, 조달 비용을 무시하고 실무적 측면을 망각한다.
이외에도 많이 있지만, 더 나열해 봐야 의미가 없는데 바로 다음 절의 제목이기도 해서 생략한다.

### Even if your Backtest is flawless, It is probably wrong

축하한다! 당신의 백테스트가 누구든 결과를 재현할 수 있고 가정이 매우 보수적이어서 직장 상사조차 인정한다는 점에서 나무랄 데가 없을 수 있다. 모든 거래에 누구보다도 더 많은 2 배 이상의 비용을 지불했다. 
지구 인구의 절반 이상이 알게 된 정보를 몇 시간 후에 이용했고, 매우 낮은 거래량 환경에서 거래를 실행했다.
이 엄청난 모든 비용에도 불구하고 백테스트는 여전히 많은 수익을 낸다. 
그럼에도 이 흠결 없는 백테스트가 잘못됐을 가능성이 있다. 왜 그럴까?
왜냐하면 오직 전문가만이 완벽한 백테스트를 생성할 수 있기 때문이다.
따라서 당신은 전문가임에 틀림없는데, 전문가라 함은 또한 수년 동안 수만 번의 백테스트를 실행했다는 것을 의미한다.
결론적으로 말하면 이 백테스트는 당신이 첫 번째로 생성한 것이 아니다.
그러므로 이것이 잘못된 발견일 가능성, 즉 동일한 데이터셋에 대해 수 차례 테스트를 수행하다 보면 필연적으로 발생하는 통계적 요행일 가능성을 고려해야 한다.

백테스트가 사람을 미치게 만드는 점은 백테스트에 익숙해질수록 더 많이 잘못된 발견을 한다는 것이다. 
초보자들은 Luo 등(2014)의 일곱 가지 죄악에 흔히 빠져들곤 한다.
전문가들이 흠결 없는 배게스트를 생성할 수 있을지 모르지만, 여전히 다중 테스트, 선택 편향, 백테스트 과적합의 가능성에 빠져 있는 것이다.

### Backtesting is not a Research Tool

Chapter 8에서 대체 효과, 결합 효과, 마스킹, MDI, MDA, SFI, 병렬화된 특성, 스태킹 특성 등을 알아봤다. 어떤 특성들이 매우 중요하더라도 그 특성이 투자 전략에서 이익을 창출한다는 의미는 아니다.
이와 반대로 상관없는 특성들에 기반을 두고 있지만 수익성이 좋아 보이는 전략들이 많다.
특성 중요도는 수익성에 관계없이, 머신러닝 알고리즘에 의해 발견된 패턴의 성질을 이해하는 데 도움을 주기 때문에 진정한 연구 도구가 된다.
무엇보다 결정적인 부분은 특성 중요도가 과거 성과를 시뮬레이션하기 전에 사전적으로 도출된다는 것이다.

이에 반해 백테스트는 연구 도구가 아니다. 백테스트는 특정 전략이 수익을 내게 된 이유에 관한 통찰을 주지 못한다. 
복권 당첨자가 자신이 운이 좋은 이유는 뭘 했기 때문이라고 여기듯이 항상 사후 이야기가 있는 법이다.
논문의 저자들은 수백 개의 'Alpha'와 'Factor'들을 찾았다고 주장하며, 항상 매우 난해한 설명이 따른다. 
그들은 마지막 게임에 당첨된 복권 티켓을 찾은 것이다. 
당첨자는 돈을 벌지만, 그 숫자는 다음 번에 아무런 소용이 없다. 이 복권 티켓들에 별도로 돈을 지불하지 않을 거라면 수백 개의 알파가 무슨 소용이 있는가?
이런 저자들은 이미 팔려 나간 모든 복권에 관해서는 절대 얘기하지 않는다. 
즉 이 행운의 알파를 찾기 위해 실행했던 수백만 번의 시뮬레이션을 말한다.

백테스트의 목적은 나쁜 모델을 폐기하는 것이지 개선하는 것이 아니다. 모델을 백테스트에 의존해 수정하는 것은 시간 낭비일 뿐 아니라 위험하기도 하다.
시간과 노력은 이 책의 다른 부분에 설명한 올바른 부분, 예컨대 Structured Data, Labeling, Weightening, Ensemble, Cross validation, Feature Importance, Betting size 등의 연구에 사용해야 한다.
백테스트를 할 즈음이면 너무 늦는다. 
모델이 충분히 정의되기 전에 백테스트를 해서는 안 된다.
백테스트가 실패하면 모두 다시 해야 한다.
이렇게 하면 잘못된 발견을 할 가능성은 근본적으로 줄어든다.
하지만 여전히 0은 아니다.